# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö LoL Meta Analyzer

## üéØ –¶–µ–ª—å
–°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (Win/Pick/Ban rate) —á–µ–º–ø–∏–æ–Ω–æ–≤ –¥–ª—è **–≤—Å–µ—Ö —Ä–∞–Ω–≥–æ–≤** (Iron, Bronze, Silver, Gold, Platinum, Emerald, Diamond, Master, Grandmaster, Challenger) –Ω–∞ RU —Å–µ—Ä–≤–µ—Ä–µ –≤ solo-queue –º–∞—Ç—á–∞—Ö.

## üìä –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 3 –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤:
1. **–†–∞–∑–≤–µ–¥–∫–∞** (`-discover-players-`) - –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –≤—Å–µ—Ö —Ä–∞–Ω–≥–æ–≤
2. **–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å** (`-queue-matches-`) - —Å–±–æ—Ä ID –º–∞—Ç—á–µ–π –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞** (`-process-matches-`) - —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –º–∞—Ç—á–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è** (`-aggregate-stats-`, SQL —Ñ—É–Ω–∫—Ü–∏–∏) - –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (`-check-new-patch-`) - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–∞—Ç—á–µ–π
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API** (`-reset-api-limits-`) - —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤ API –∫–ª—é—á–µ–π

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
Riot Games API
    ‚Üì
[1] discover-players (Edge Function)
    ‚Üì
tracked_players + whitelist_players
    ‚Üì
[2] queue-matches (Edge Function)
    ‚Üì
matches_queue (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ match_id)
    ‚Üì
[3] process-matches (Edge Function)
    ‚Üì
match_participants_stats + match_bans
    ‚Üì
[4] aggregate_champion_stats (SQL Function)
    ‚Üì
champion_stats_aggregated
    ‚Üì
Tauri Frontend (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
```

---

## üõ† Edge Functions (Supabase)

### 1. `-discover-players-` (v10)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –≤—Å–µ—Ö —Ä–∞–Ω–≥–æ–≤ RU —Å–µ—Ä–≤–µ—Ä–∞.

**API Endpoints:**
- –î–ª—è —Ä–∞–Ω–≥–æ–≤ —Å –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏ (IRON-DIAMOND): `/lol/league-exp/v4/entries/RANKED_SOLO_5x5/{TIER}/{DIVISION}?page={page}`
- –î–ª—è Master/Grandmaster: `/lol/league/v4/entries/RANKED_SOLO_5x5/{TIER}?page={page}`
- –î–ª—è Challenger: `/lol/league/v4/challengerleagues/by-queue/RANKED_SOLO_5x5`

**–†–∞–Ω–≥–∏ –∏ –¥–∏–≤–∏–∑–∏–æ–Ω—ã:**
- **7 —Ä–∞–Ω–≥–æ–≤ √ó 4 –¥–∏–≤–∏–∑–∏–æ–Ω–∞ = 28 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π:** IRON, BRONZE, SILVER, GOLD, PLATINUM, EMERALD, DIAMOND (–∫–∞–∂–¥—ã–π —Å –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏ I, II, III, IV)
- **2 —Ä–∞–Ω–≥–∞ √ó 1 –¥–∏–≤–∏–∑–∏–æ–Ω = 2 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:** MASTER, GRANDMASTER (—Ç–æ–ª—å–∫–æ I)
- **1 —Ä–∞–Ω–≥ (Challenger) = 1 –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:** CHALLENGER (–æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint)
- **–í—Å–µ–≥–æ: 31 –∫–æ–º–±–∏–Ω–∞—Ü–∏—è**

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π API –∫–ª—é—á –∏–∑ `api_keys` (purpose: "discover")
2. –ü–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –≤—Å–µ 31 –∫–æ–º–±–∏–Ω–∞—Ü–∏—é —Ä–∞–Ω–≥–æ–≤/–¥–∏–≤–∏–∑–∏–æ–Ω–æ–≤
3. –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (1-3)
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –º–∞—Ç—á–µ–π —á–µ—Ä–µ–∑ `/lol/match/v5/matches/by-puuid/{puuid}/ids`
5. –ï—Å–ª–∏ –º–∞—Ç—á–∏ –Ω–∞–π–¥–µ–Ω—ã ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `tracked_players` –∏ `whitelist_players`
6. –ï—Å–ª–∏ 400 –æ—à–∏–±–∫–∞ ‚Üí –ø–æ–º–µ—á–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –∫–∞–∫ `invalid: true`
7. –£—á–∏—Ç—ã–≤–∞–µ—Ç –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API –∫–ª—é—á–∞ (`requests_limit`)

**Response:**
```json
{
  "upserted": 99,
  "validated": 99,
  "skippedExisting": 0,
  "skippedMissing": 0,
  "banned400": 0,
  "requests": 100
}
```

**Cron:** –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã (`*/2 * * * *`)

---

### 2. `-queue-matches-` (v9)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–±–æ—Ä ID –º–∞—Ç—á–µ–π –∏–≥—Ä–æ–∫–æ–≤ –∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏—Ö –≤ –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

**API Endpoint:** `/lol/match/v5/matches/by-puuid/{puuid}/ids?start=0&count=10`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π API –∫–ª—é—á (purpose: "queue-matches")
2. –ë–µ—Ä–µ—Ç 5 –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ `whitelist_players` —Å `invalid: false`, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ `last_scan_time` (—Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏)
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞:
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `last_scan_time` –≤ `whitelist_players` –∏ `tracked_players`
   - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∞—Ç—á–µ–π
   - –í—Å—Ç–∞–≤–ª—è–µ—Ç ID –º–∞—Ç—á–µ–π –≤ `matches_queue` —Å `status: "PENDING"` –∏ `ON CONFLICT DO NOTHING` (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)
4. –ï—Å–ª–∏ 400 –æ—à–∏–±–∫–∞ ‚Üí –ø–æ–º–µ—á–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –∫–∞–∫ `invalid: true`

**Response:**
```json
{
  "processed_players": 5,
  "requests_made": 5,
  "errors": []
}
```

**Cron:** –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã (`*/2 * * * *`)

---

### 3. `-process-matches-` (v6)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –º–∞—Ç—á–µ–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç—á–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

**API Endpoint:** `/lol/match/v5/matches/{matchId}`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–∞—Ç—á –∏–∑ `https://ddragon.leagueoflegends.com/api/versions.json` (—Ñ–æ—Ä–º–∞—Ç: "15.24")
2. –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–π API –∫–ª—é—á (purpose: "process")
3. –ë–µ—Ä–µ—Ç –¥–æ 200 –º–∞—Ç—á–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING` –∏–∑ `matches_queue`
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç—á–∞ (–º–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –∑–∞–ø—É—Å–∫):
   - –ó–∞–¥–µ—Ä–∂–∫–∞ 60ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (~16 rps)
   - –°–∫–∞—á–∏–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –º–∞—Ç—á–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `gameVersion` - –µ—Å–ª–∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ç—á–∞ ‚Üí `status: "SKIPPED"`
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–Ω–≥ –º–∞—Ç—á–∞ (`tier`) –∏–∑ `tracked_players` –ø–æ `participantPuuids`
   - –ï—Å–ª–∏ —Ä–∞–Ω–≥ `UNKNOWN` ‚Üí `status: "SKIPPED"`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ `match_participants_stats`:
     - `match_id`, `patch_version`, `champion_id`, `win`, `position`, `tier`, `region`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–∞–Ω—ã –≤ `match_bans` (–∏–∑ `teams[].bans`)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á–∞ –Ω–∞ `PROCESSED`

**Response:**
```json
{
  "processed": 50,
  "skipped": 10,
  "failed": 2,
  "requests": 62
}
```

**Cron:** –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã (`*/2 * * * *`)

---

### 4. `-collect-matches-` (v5)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–±–æ—Ä –º–∞—Ç—á–µ–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `matches` –∏ `match_participants`, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å).

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ –ë–î. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–æ–π —Ü–µ–ª–∏.

**Cron:** –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã (`*/2 * * * *`)

---

### 5. `-aggregate-stats-` (v1)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Å—á–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ–º–ø–∏–æ–Ω–æ–≤ –∏–∑ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ç—á –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–∞—Ç—á –∏–∑ DDragon
2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `region` –∏ `tier`
3. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–∞—Ç—á–∞/—Ä–µ–≥–∏–æ–Ω–∞/—Ä–∞–Ω–≥–∞
4. –í—ã–∑—ã–≤–∞–µ—Ç SQL —Ñ—É–Ω–∫—Ü–∏—é `calculate_champion_stats(p_patch, p_region, p_tier)`
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ `champion_stats_aggregated`

**Request:**
```json
{
  "patch": "15.24",
  "region": "ru",
  "tier": "DIAMOND"
}
```

**Response:**
```json
{
  "success": true,
  "patch": "15.24",
  "region": "ru",
  "tier": "DIAMOND"
}
```

---

### 6. `-check-new-patch-` (v1)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ç—á–∞ –∏ –∑–∞–ø—É—Å–∫ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–∞—Ç—á–∞.

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–∞—Ç—á –∏–∑ DDragon
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –º–∞—Ç—á–µ–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ç—á–∞
3. –ï—Å–ª–∏ –ø–∞—Ç—á –Ω–æ–≤—ã–π –∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–∞—Ç—á –±–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç `-aggregate-stats-` –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–∞—Ç—á–∞

**Response:**
```json
{
  "success": true,
  "currentPatch": "15.24",
  "isNewPatch": false,
  "hasStats": true,
  "hasMatches": true
}
```

---

### 7. `-reset-api-limits-` (v1)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ `requests_used` –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö API –∫–ª—é—á–µ–π.

**–õ–æ–≥–∏–∫–∞:**
1. –û–±–Ω–æ–≤–ª—è–µ—Ç `requests_used = 0` –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π —Å `is_active: true`

**Response:**
```json
{
  "message": "API limits reset successfully",
  "updated_keys": 13
}
```

**Cron:** –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã (`*/2 * * * *`)

---

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Supabase)

### `api_keys`
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Riot Games API –∫–ª—é—á–∞–º–∏ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∏ –ª–∏–º–∏—Ç–∞–º–∏.

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `id` | bigint | PK, –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç |
| `key_value` | text | –ó–Ω–∞—á–µ–Ω–∏–µ API –∫–ª—é—á–∞ |
| `region` | text | –†–µ–≥–∏–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'ru') |
| `is_active` | boolean | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –∫–ª—é—á |
| `is_primary` | boolean | –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á |
| `rotation_order` | integer | –ü–æ—Ä—è–¥–æ–∫ —Ä–æ—Ç–∞—Ü–∏–∏ |
| `purpose` | text | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: "discover", "queue-matches", "process", "collect" |
| `requests_used` | integer | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0) |
| `requests_limit` | integer | –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100) |
| `reset_at` | timestamptz | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞ |
| `last_used_at` | timestamptz | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |
| `created_at` | timestamptz | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| `expires_at` | timestamptz | –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è |

**RLS:** –í–∫–ª—é—á–µ–Ω

---

### `tracked_players`
–ö—ç—à –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–∞—Ç—á–µ–π.

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `puuid` | text | PK, PUUID –∏–≥—Ä–æ–∫–∞ |
| `tier` | text | –†–∞–Ω–≥: IRON, BRONZE, SILVER, GOLD, PLATINUM, EMERALD, DIAMOND, MASTER, GRANDMASTER, CHALLENGER |
| `division` | text | –î–∏–≤–∏–∑–∏–æ–Ω: I, II, III, IV (–¥–ª—è —Ä–∞–Ω–≥–æ–≤ —Å –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏), I (–¥–ª—è Master+) |
| `region` | text | –†–µ–≥–∏–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'ru') |
| `last_scan_time` | timestamptz | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |
| `created_at` | timestamptz | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| `invalid` | boolean | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–≥—Ä–æ–∫ (400 –æ—à–∏–±–∫–∞) |

**RLS:** –í—ã–∫–ª—é—á–µ–Ω

---

### `whitelist_players`
–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `puuid` | text | PK, PUUID –∏–≥—Ä–æ–∫–∞ |
| `summoner_name` | text | –ò–º—è –ø—Ä–∏–∑—ã–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| `tier` | text | –†–∞–Ω–≥ |
| `division` | text | –î–∏–≤–∏–∑–∏–æ–Ω |
| `region` | text | –†–µ–≥–∏–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'ru') |
| `last_scan_time` | timestamptz | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |
| `invalid` | boolean | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–≥—Ä–æ–∫ |

**RLS:** –í—ã–∫–ª—é—á–µ–Ω

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** `-discover-players-` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å `tracked_players` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–æ–≤.

---

### `matches_queue`
–û—á–µ—Ä–µ–¥—å –º–∞—Ç—á–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ö–∞–± –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏).

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `match_id` | text | PK, ID –º–∞—Ç—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "RU_12345678") |
| `status` | enum | PENDING, PROCESSED, SKIPPED, FAILED |
| `region` | text | –†–µ–≥–∏–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'ru') |
| `created_at` | timestamptz | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| `processed_at` | timestamptz | –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `error_message` | text | –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–¥–ª—è FAILED/SKIPPED) |

**RLS:** –í—ã–∫–ª—é—á–µ–Ω

**–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:** `match_id` —è–≤–ª—è–µ—Ç—Å—è PK, –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT DO NOTHING`.

---

### `match_participants_stats`
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–∞—Ç—á–µ–π (—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏).

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `id` | bigint | PK, –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç |
| `match_id` | text | FK ‚Üí `matches_queue.match_id` |
| `patch_version` | text | –í–µ—Ä—Å–∏—è –ø–∞—Ç—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "15.24") |
| `champion_id` | text | ID —á–µ–º–ø–∏–æ–Ω–∞ |
| `win` | boolean | –ü–æ–±–µ–¥–∞/–ø–æ—Ä–∞–∂–µ–Ω–∏–µ |
| `position` | text | –ü–æ–∑–∏—Ü–∏—è: TOP, JUNGLE, MIDDLE, BOTTOM, UTILITY, UNKNOWN |
| `tier` | text | –†–∞–Ω–≥ –∏–≥—Ä–æ–∫–∞ –≤ –º–∞—Ç—á–µ |
| `region` | text | –†–µ–≥–∏–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'ru') |
| `created_at` | timestamptz | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |

**RLS:** –í—ã–∫–ª—é—á–µ–Ω

---

### `match_bans`
–ë–∞–Ω—ã —á–µ–º–ø–∏–æ–Ω–æ–≤ –≤ –º–∞—Ç—á–∞—Ö.

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `match_id` | text | PK, FK ‚Üí `matches_queue.match_id` |
| `champion_id` | text | PK, ID –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ —á–µ–º–ø–∏–æ–Ω–∞ |
| `patch_version` | text | –í–µ—Ä—Å–∏—è –ø–∞—Ç—á–∞ |
| `region` | text | –†–µ–≥–∏–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'ru') |
| `created_at` | timestamptz | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |

**RLS:** –í—ã–∫–ª—é—á–µ–Ω

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°–æ—Å—Ç–∞–≤–Ω–æ–π PK (`match_id`, `champion_id`), –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT DO NOTHING`.

---

### `champion_stats_aggregated`
–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ–º–ø–∏–æ–Ω–æ–≤ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI).

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `id` | bigint | PK, –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç |
| `champion_id` | text | ID —á–µ–º–ø–∏–æ–Ω–∞ |
| `patch_version` | text | –í–µ—Ä—Å–∏—è –ø–∞—Ç—á–∞ |
| `region` | text | –†–µ–≥–∏–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'ru') |
| `tier` | text | –†–∞–Ω–≥ (IRON, BRONZE, ..., CHALLENGER) |
| `role` | text | –ü–æ–∑–∏—Ü–∏—è (TOP, JUNGLE, MIDDLE, BOTTOM, UTILITY) –∏–ª–∏ NULL (–≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏) |
| `total_matches` | integer | –í—Å–µ–≥–æ –º–∞—Ç—á–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0) |
| `wins` | integer | –ü–æ–±–µ–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0) |
| `losses` | integer | –ü–æ—Ä–∞–∂–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0) |
| `bans` | integer | –ë–∞–Ω–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0) |
| `picks` | integer | –ü–∏–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0) |
| `win_rate` | numeric | Win rate –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –¥–æ 2 –∑–Ω–∞–∫–æ–≤) |
| `pick_rate` | numeric | Pick rate –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –¥–æ 2 –∑–Ω–∞–∫–æ–≤) |
| `ban_rate` | numeric | Ban rate –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –¥–æ 2 –∑–Ω–∞–∫–æ–≤) |
| `last_updated` | timestamptz | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: now()) |

**RLS:** –í—ã–∫–ª—é—á–µ–Ω

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:** `(champion_id, patch_version, region, tier, role)` - –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏.

---

### `patch_notes`
–ó–∞–º–µ—Ç–∫–∏ –æ –ø–∞—Ç—á–∞—Ö (–¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è).

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `id` | bigint | PK, –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç |
| `patch_version` | text | –í–µ—Ä—Å–∏—è –ø–∞—Ç—á–∞ |
| `champion_id` | text | ID —á–µ–º–ø–∏–æ–Ω–∞ |
| `change_type` | text | –¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è |
| `category` | text | –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'Champions') |
| `title` | text | –ó–∞–≥–æ–ª–æ–≤–æ–∫ |
| `summary` | text | –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ |
| `image_url` | text | URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| `created_at` | timestamptz | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |

**RLS:** –í–∫–ª—é—á–µ–Ω

---

## üîß SQL Functions

### `aggregate_champion_stats(patch_ver TEXT)`

–ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ–º–ø–∏–æ–Ω–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–∞—Ç—á–∞ –∏–∑ `match_participants_stats`.

**–õ–æ–≥–∏–∫–∞:**
1. –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ `champion_id`, `patch_version`, `region`, `tier`, `position`
2. –í—ã—á–∏—Å–ª—è–µ—Ç:
   - `win_rate`: –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∞—Ç—á–µ–π
   - `pick_rate`: –ø—Ä–æ—Ü–µ–Ω—Ç –ø–∏–∫–æ–≤ –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–∞—Ç—á–µ–π (–¥–µ–ª–∏—Ç—Å—è –Ω–∞ 10, —Ç.–∫. –≤ –º–∞—Ç—á–µ 10 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
   - `ban_rate`: NULL (–Ω–µ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≤ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
   - `total_matches`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ON CONFLICT DO UPDATE` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π

**–í—ã–∑–æ–≤:**
```sql
SELECT aggregate_champion_stats('15.24');
```

---

### `refresh_latest_stats()`

–û–±–Ω–æ–≤–ª—è–µ—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ç—á–µ–π, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ `match_participants_stats`.

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ `patch_version` –∏–∑ `match_participants_stats`
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ç—á–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `aggregate_champion_stats(patch_version)`

**–í—ã–∑–æ–≤:**
```sql
SELECT refresh_latest_stats();
```

**Cron:** –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (`* * * * *`)

---

### `calculate_champion_stats(p_patch TEXT, p_region TEXT, p_tier TEXT)`

–í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ–º–ø–∏–æ–Ω–æ–≤ —Å —É—á–µ—Ç–æ–º –±–∞–Ω–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `-aggregate-stats-`).

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç `aggregate_champion_stats` –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å –±–∞–Ω—ã –∏–∑ `match_bans`.

---

### `increment_api_key_usage(key_id INTEGER)`

–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ `requests_used` –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ API –∫–ª—é—á–∞.

**–í—ã–∑–æ–≤:**
```sql
SELECT increment_api_key_usage(1);
```

---

### `reset_api_key_limits()`

–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ `requests_used` –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π.

**–í—ã–∑–æ–≤:**
```sql
SELECT reset_api_key_limits();
```

---

### –î—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

- `aggregate_all_patches()` - –∞–≥—Ä–µ–≥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ç—á–µ–π —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- `extract_patch()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ø–∞—Ç—á–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏
- `get_stats_patches()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞—Ç—á–µ–π —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- `cleanup_expired_api_keys()` - –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö API –∫–ª—é—á–µ–π

---

## ‚è∞ Cron Jobs (pg_cron)

–í—Å–µ cron jobs –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `net.http_post` –¥–ª—è –≤—ã–∑–æ–≤–∞ Edge Functions.

### 1. `discover-players` (Job ID: 67)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/2 * * * *` (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)
- **–§—É–Ω–∫—Ü–∏—è:** `-discover-players-`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –≤—Å–µ—Ö —Ä–∞–Ω–≥–æ–≤

### 2. `queue-matches` (Job ID: 68)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/2 * * * *` (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)
- **–§—É–Ω–∫—Ü–∏—è:** `-queue-matches-`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞—Ç—á–µ–π –≤ –æ—á–µ—Ä–µ–¥—å

### 3. `collect-matches` (Job ID: 69)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/2 * * * *` (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)
- **–§—É–Ω–∫—Ü–∏—è:** `-collect-matches-`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–±–æ—Ä –º–∞—Ç—á–µ–π

### 4. `process-matches` (Job ID: 70)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/2 * * * *` (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)
- **–§—É–Ω–∫—Ü–∏—è:** `-process-matches-`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ç—á–µ–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏

### 5. `reset-api-limits` (Job ID: 73)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `*/2 * * * *` (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)
- **–§—É–Ω–∫—Ü–∏—è:** `-reset-api-limits-`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤ API –∫–ª—é—á–µ–π

### 6. `refresh_latest_stats` (Job ID: 76)
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** `* * * * *` (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
- **–ö–æ–º–∞–Ω–¥–∞:** `SELECT refresh_latest_stats()`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## üö´ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –º–∞—Ç—á–µ–π

–ü—Ä–æ–±–ª–µ–º–∞: –ï—Å–ª–∏ –º—ã –ø—Ä–æ—Å—Ç–æ –∏–¥–µ–º –ø–æ –∏–≥—Ä–æ–∫–∞–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –º–∞—Ç—á–∏, –º—ã –Ω–µ–∏–∑–±–µ–∂–Ω–æ —Å—Ç–æ–ª–∫–Ω–µ–º—Å—è —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏:
- –ò–≥—Ä–æ–∫ –ê (Emerald I) —Å—ã–≥—Ä–∞–ª –º–∞—Ç—á #123
- –ò–≥—Ä–æ–∫ –ë (Emerald I) —Ç–æ–∂–µ –±—ã–ª –≤ –º–∞—Ç—á–µ #123
- –ú—ã —Å–∫–∞—á–∏–≤–∞–µ–º –º–∞—Ç—á #123 –¥–≤–∞–∂–¥—ã ‚Üí –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–≤–∞–∏–≤–∞–µ—Ç—Å—è ‚Üí –õ–∏–º–∏—Ç—ã API —Ç—Ä–∞—Ç—è—Ç—Å—è –≤–ø—É—Å—Ç—É—é

**–†–µ—à–µ–Ω–∏–µ:**
1. –¢–∞–±–ª–∏—Ü–∞ `matches_queue` –∏–º–µ–µ—Ç `match_id` –∫–∞–∫ Primary Key
2. –ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT DO NOTHING` –∏–ª–∏ `ignoreDuplicates: true`
3. –ï—Å–ª–∏ –º–∞—Ç—á —É–∂–µ –Ω–∞–π–¥–µ–Ω –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–æ–º ‚Üí –æ–Ω –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ `match_id`

---

## üì° Riot Games API Endpoints

### League API (RU Server)
- **Base URL:** `https://ru.api.riotgames.com`
- **Endpoints:**
  - `/lol/league-exp/v4/entries/RANKED_SOLO_5x5/{TIER}/{DIVISION}?page={page}` - —Ä–∞–Ω–≥–∏ —Å –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏
  - `/lol/league/v4/entries/RANKED_SOLO_5x5/{TIER}?page={page}` - Master/Grandmaster
  - `/lol/league/v4/challengerleagues/by-queue/RANKED_SOLO_5x5` - Challenger

### Match API (Europe)
- **Base URL:** `https://europe.api.riotgames.com`
- **Endpoints:**
  - `/lol/match/v5/matches/by-puuid/{puuid}/ids?start=0&count={count}` - —Å–ø–∏—Å–æ–∫ –º–∞—Ç—á–µ–π –∏–≥—Ä–æ–∫–∞
  - `/lol/match/v5/matches/{matchId}` - –¥–µ—Ç–∞–ª–∏ –º–∞—Ç—á–∞

### Data Dragon
- **Base URL:** `https://ddragon.leagueoflegends.com`
- **Endpoints:**
  - `/api/versions.json` - —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø–∞—Ç—á–µ–π

---

## üéÆ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–Ω–≥–æ–≤

### –†–∞–Ω–≥–∏ —Å 4 –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏ (tier 1-4)
–ö–∞–∂–¥—ã–π —Ä–∞–Ω–≥ –∏–º–µ–µ—Ç 4 –¥–∏–≤–∏–∑–∏–æ–Ω–∞ (I, II, III, IV), –≥–¥–µ I - –≤—ã—Å—à–∏–π:
- IRON (I, II, III, IV)
- BRONZE (I, II, III, IV)
- SILVER (I, II, III, IV)
- GOLD (I, II, III, IV)
- PLATINUM (I, II, III, IV)
- EMERALD (I, II, III, IV)
- DIAMOND (I, II, III, IV)

### –†–∞–Ω–≥–∏ —Å 1 –¥–∏–≤–∏–∑–∏–æ–Ω–æ–º (tier 1)
- MASTER (I)
- GRANDMASTER (I)
- CHALLENGER (I)

**–í—Å–µ–≥–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π:** 7 √ó 4 + 3 √ó 1 = **31 –∫–æ–º–±–∏–Ω–∞—Ü–∏—è**

---

## üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞–º–∏

### –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π
- –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª—é—á–∏ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º `purpose`
- –ö–ª—é—á–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ `rotation_order` (ascending)
- –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ (`requests_used >= requests_limit`) –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á
- –ü—Ä–∏ 403/401 –æ—à–∏–±–∫–µ –∫–ª—é—á –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `is_active: false`

### –õ–∏–º–∏—Ç—ã
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `requests_limit: 100` –∑–∞–ø—Ä–æ—Å–æ–≤
- –°—á–µ—Ç—á–∏–∫ `requests_used` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `increment_api_key_usage()`
- –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ `-reset-api-limits-` –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã

---

## üì± Frontend (Tauri)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **App.tsx** - –≥–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–ø–∞—Ç—á, —Ä–æ–ª—å, —Ä–µ–≥–∏–æ–Ω, —Ä–∞–Ω–≥)
- **RealStatsView** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ `champion_stats_aggregated`

### Rust Backend (`src-tauri/src/lib.rs`)
- `get_real_stats` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ Supabase REST API
- `get_available_stats_patches` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞—Ç—á–µ–π

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- **–†–∞–Ω–≥:** –í—Å–µ —Ä–∞–Ω–≥–∏ –æ—Ç IRON –¥–æ CHALLENGER (—Å –∏–∫–æ–Ω–∫–∞–º–∏)
- **–†–æ–ª—å:** TOP, JUNGLE, MIDDLE, BOTTOM, UTILITY, ALL
- **–ü–∞—Ç—á:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ç—á–∞
- **–†–µ–≥–∏–æ–Ω:** RU (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω)

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ Edge Functions
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª—å Supabase
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ Supabase Dashboard ‚Üí Edge Functions ‚Üí Logs

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —Ä–∞–Ω–≥–∞–º
SELECT tier, COUNT(*) FROM tracked_players GROUP BY tier;

-- –°—Ç–∞—Ç—É—Å—ã –º–∞—Ç—á–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏
SELECT status, COUNT(*) FROM matches_queue GROUP BY status;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∞—Ç—á–∞–º
SELECT patch_version, COUNT(*) FROM match_participants_stats GROUP BY patch_version;

-- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT champion_id, tier, role, total_matches, win_rate 
FROM champion_stats_aggregated 
WHERE patch_version = '15.24' 
ORDER BY total_matches DESC;
```

---

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Edge Functions
–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Supabase MCP –∏–ª–∏ CLI:
```bash
supabase functions deploy discover-players
supabase functions deploy queue-matches
supabase functions deploy process-matches
supabase functions deploy aggregate-stats
supabase functions deploy check-new-patch
supabase functions deploy reset-api-limits
```

### Cron Jobs
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ SQL:
```sql
SELECT cron.schedule(
  'discover-players',
  '*/2 * * * *',
  $$
  SELECT net.http_post(
    url:='https://pnrixpwwjasjizuamuwu.supabase.co/functions/v1/-discover-players-',
    headers:='{"Content-Type":"application/json","Authorization":"Bearer ..."}'::jsonb
  )
  $$
);
```

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ü–∞—Ç—á–∏:** –í–µ—Ä—Å–∏—è –ø–∞—Ç—á–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ `gameVersion` –º–∞—Ç—á–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –¥–æ —Ñ–æ—Ä–º–∞—Ç–∞ "15.24" (–ø–µ—Ä–≤—ã–µ 2 —á–∏—Å–ª–∞)
2. **–†–∞–Ω–≥–∏:** –í—Å–µ —Ä–∞–Ω–≥–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –¥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞ (IRON, BRONZE, ..., CHALLENGER)
3. **–ü–æ–∑–∏—Ü–∏–∏:** –ù–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –¥–æ: TOP, JUNGLE, MIDDLE, BOTTOM, UTILITY, UNKNOWN
4. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ `matches_queue` —á–µ—Ä–µ–∑ PK –Ω–∞ `match_id`
5. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è:** –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ —Ä–∞–Ω–≥—É –±–µ–∑ —É—á–µ—Ç–∞ –¥–∏–≤–∏–∑–∏–æ–Ω–∞ (–≤—Å–µ –¥–∏–≤–∏–∑–∏–æ–Ω—ã –æ–¥–Ω–æ–≥–æ —Ä–∞–Ω–≥–∞ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è)
